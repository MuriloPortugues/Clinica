<!DOCTYPE html>
<html th:replace="~{fragments/layout :: layout(~{::head},~{::main})}"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head(~{}, ~{::title})}">
    <title>Buscar e Agendar Consultas</title>
</head>
<body>
<main class="container mt-4">
    <div class="card shadow p-4">
        <h2 class="text-center fw-bold text-primary mb-4 fs-3">
            <i class="bi bi-calendar-check me-2"></i>Buscar Horários Disponíveis
        </h2>

        <!-- Formulário de Filtro -->
        <form th:action="@{/agenda/filtrar}" method="get" class="row g-3 align-items-end mb-4">
            <div class="col-md-3">
                <label for="inicio" class="form-label">Data e Hora Início:</label>
                <input type="datetime-local" id="inicio" name="inicio" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="fim" class="form-label">Data e Hora Fim:</label>
                <input type="datetime-local" id="fim" name="fim" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="medicoId" class="form-label">Médico:</label>
                <select id="medicoId" name="medicoId" class="form-select">
                    <option value="">-- Todos os médicos --</option>
                    <option th:each="medico : ${medicos}"
                            th:value="${medico.id}"
                            th:text="${medico.nome}"
                            th:selected="${medico.id == medicoSelecionadoId}">
                    </option>
                </select>
            </div>
            <div class="col-md-3 text-center">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="bi bi-search me-1"></i> Buscar
                </button>
            </div>
        </form>

        <!-- Lista de Horários -->
        <div th:if="${agendas != null} and ${agendas.size() > 0}">
            <h4 class="mb-3">Horários Encontrados</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle text-center">
                    <thead class="table-primary">
                    <tr>
                        <th>Início</th>
                        <th>Fim</th>
                        <th>Médico</th>
                        <th>Ação</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="agenda : ${agendas}">
                        <td th:text="${#temporals.format(agenda.inicio, 'dd/MM/yyyy HH:mm')}"></td>
                        <td th:text="${#temporals.format(agenda.fim, 'dd/MM/yyyy HH:mm')}"></td>
                        <td th:text="${agenda.medico.nome}"></td>
                        <td>
                            <div class="d-flex justify-content-center gap-2">
                                <!-- Botão Agendar -->
                                <form th:action="@{/consulta/form(tipo='agendamento', agendaId=${agenda.id})}" method="get">
                                    <input type="hidden" name="agendaId" th:value="${agenda.id}" />
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-calendar-plus me-1"></i> Agendar
                                    </button>
                                </form>

                                <!-- Editar / Excluir -->
                                <div sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MEDICO')" class="d-flex gap-2">
                                    <form th:action="@{/agenda/editAgenda/{id}(id=${agenda.id})}">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="bi bi-pencil-square me-1"></i> Editar
                                        </button>
                                    </form>
                                    <form th:action="@{/agenda/excluir}" method="post"
                                          onsubmit="return confirm('Tem certeza que deseja excluir este horário?');">
                                        <input type="hidden" name="id" th:value="${agenda.id}" />
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="bi bi-trash me-1"></i> Excluir
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Nenhum horário encontrado -->
        <div th:if="${agendas == null or agendas.size() == 0}" class="text-center mt-4">
            <p class="text-muted"><i class="bi bi-exclamation-circle me-1"></i> Nenhum horário disponível no momento.</p>
        </div>

        <!-- Botões de Navegação -->
        <div class="text-center mt-4">
            <a href="/consulta/apresentarConsulta" class="btn btn-info mx-1">
                <i class="bi bi-list-ul me-1"></i> Ver Consultas
            </a>
            <a href="/hospital/home" class="btn btn-secondary mx-1">
                <i class="bi bi-house-door me-1"></i> Home
            </a>
        </div>
    </div>
</main>

<!-- Bootstrap Icons (se ainda não estiver no layout) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</body>
</html>
